(self.webpackChunkdocusaurus_test=self.webpackChunkdocusaurus_test||[]).push([[9236],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return d}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),f=c(n),d=r,g=f["".concat(l,".").concat(d)]||f[d]||p[d]||i;return n?a.createElement(g,o(o({ref:t},u),{},{components:n})):a.createElement(g,o({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=f;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},3295:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},metadata:function(){return l},toc:function(){return c},default:function(){return p}});var a=n(2122),r=n(9756),i=(n(7294),n(3905)),o=["components"],s={sidebar_position:2},l={unversionedId:"extend/cases/kafka",id:"extend/cases/kafka",isDocsHomePage:!1,title:"Bridge to Kafka",description:"We touched on the messaging aspect of AuthGuard in the design sectio, and went more into details on how to subscribe to internal events in the events subscribers. So far it has been all internal, but ultimately, AuthGuard will run as part of a larger system. You can connect it to other parts of the system by providing an events bridge.",source:"@site/docs/extend/cases/kafka.md",sourceDirName:"extend/cases",slug:"/extend/cases/kafka",permalink:"/docs/extend/cases/kafka",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/extend/cases/kafka.md",version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"API Routes",permalink:"/docs/extend/routes"},next:{title:"Generating Custom API Keys",permalink:"/docs/extend/cases/api-keys"}},c=[{value:"Configuration",id:"configuration",children:[]},{value:"Message Serialization",id:"message-serialization",children:[]},{value:"Kafka Publisher",id:"kafka-publisher",children:[]},{value:"Bridge Implementation",id:"bridge-implementation",children:[]}],u={toc:c};function p(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"We touched on the messaging aspect of AuthGuard in the ",(0,i.kt)("a",{parentName:"p",href:"/docs/design"},"design sectio"),", and went more into details on how to subscribe to internal events in the ",(0,i.kt)("a",{parentName:"p",href:"/docs/extend/messaging"},"events subscribers"),". So far it has been all internal, but ultimately, AuthGuard will run as part of a larger system. You can connect it to other parts of the system by providing an events bridge."),(0,i.kt)("p",null,"An event bridge simply takes internal events and pushes them to an external messaging system. It can also change the format and structure of the events to comply with your own standards if you have certain events structure already in place."),(0,i.kt)("p",null,"Here we show how to create a bridge which takes internal events and pushes them to a Kafka topic. The full source code of this example can be found ",(0,i.kt)("a",{parentName:"p",href:"https://www.github.com/AuthGuard/kafka-emb"},"here"),"."),(0,i.kt)("h2",{id:"configuration"},"Configuration"),(0,i.kt)("p",null,"We need some configuration to make this work. Our configuration interface, ",(0,i.kt)("a",{parentName:"p",href:"https://immutables.github.io/"},"Immutables")," is used to generate the actual class."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public interface KafkaConfiguration {\n    String getClientId();\n    List<String> getBootstrapHosts();\n    Map<String, String> getTopics();\n    Map<String, String> getProducerConfig();\n}\n")),(0,i.kt)("p",null,"In the configuration we expect some standard settings like client ID, Kafka bootstrap hosts, and producer config which will be passed to the producer. We also expect a map which maps internal channels to external topics."),(0,i.kt)("p",null,"The configuration can be obtained through Guice by injecting a ",(0,i.kt)("inlineCode",{parentName:"p"},"ConfigContext")," with ",(0,i.kt)("inlineCode",{parentName:"p"},'@Named("kafka")')," annotation."),(0,i.kt)("h2",{id:"message-serialization"},"Message Serialization"),(0,i.kt)("p",null,"In order to publish a message to Kafka, you need something to serialize it. Kafka Java client already comes with a JSON serializer which is what we are going to use. Some methods were ommitted in the code snippet below but you can get the full example from the GitHub repo."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public class MessageSerializer implements Serializer<Message> {\n    private final ObjectMapper objectMapper;\n    private final JsonSerializer jsonSerializer;\n\n    public MessageSerializer() {\n        this.objectMapper = new ObjectMapper();\n        this.jsonSerializer = new JsonSerializer();\n    }\n\n    @Override\n    public byte[] serialize(final String topic, final Message message) {\n        final JsonNode jsonNode = objectMapper.valueToTree(message);\n        return jsonSerializer.serialize(topic, jsonNode);\n    }\n}\n")),(0,i.kt)("h2",{id:"kafka-publisher"},"Kafka Publisher"),(0,i.kt)("p",null,"We then prepare the publisher which will be used by our subscriber to publish to Kafka. We also ommitted the implementation of ",(0,i.kt)("inlineCode",{parentName:"p"},"KafkaProducerFactory")," which is used below."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'public class KafkaPublisher {\n    private final ImmutableKafkaConfiguration config;\n    private final KafkaProducer<String, Message> kafkaProducer;\n\n    @Inject\n    public KafkaPublisher(@Named("kafka") final ConfigContext config) {\n        this(config.asConfigBean(ImmutableKafkaConfiguration.class));\n    }\n\n    KafkaPublisher(final ImmutableKafkaConfiguration config) {\n        this.config = config;\n        this.kafkaProducer = KafkaProducerFactory.create(this.config);\n\n        LOG.info("Loaded Kafka publisher with config: {}", this.config);\n    }\n\n    public void publish(final Message message) {\n        final String topic = Optional.ofNullable(this.config.getTopics().get(message.getEventType().name()))\n                .orElseThrow(() -> new IllegalArgumentException("Unmapped event type " + message.getEventType()));\n\n        final ProducerRecord<String, Message> record = new ProducerRecord<>(topic, message);\n\n        kafkaProducer.send(record, this::kafkaSendCallback);\n    }\n\n    private void kafkaSendCallback(final RecordMetadata metadata, final Exception e) {\n        if (e != null) {\n            LOG.error("Failed to publish event with metadata {}", metadata, e);\n        }\n    }\n}\n')),(0,i.kt)("h2",{id:"bridge-implementation"},"Bridge Implementation"),(0,i.kt)("p",null,"And the final piece of the puzzle is the bridge itself"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Channel("*")\npublic class KafkaBridge implements MessageSubscriber {\n    private final KafkaPublisher kafkaPublisher;\n\n    @Inject\n    public KafkaBridge(final KafkaPublisher kafkaPublisher) {\n        this.kafkaPublisher = kafkaPublisher;\n    }\n\n    @Override\n    public void onMessage(final Message message) {\n        kafkaPublisher.publish(message);\n    }\n}\n')))}p.isMDXComponent=!0}}]);