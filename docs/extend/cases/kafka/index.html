<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="AuthGuard Documentation Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="AuthGuard Documentation Blog Atom Feed"><title data-react-helmet="true">Bridge to Kafka | AuthGuard Documentation</title><meta data-react-helmet="true" property="og:url" content="https://authguard.github.io/docs/extend/cases/kafka"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Bridge to Kafka | AuthGuard Documentation"><meta data-react-helmet="true" name="description" content="We touched on the messaging aspect of AuthGuard in the design sectio, and went more into details on how to subscribe to internal events in the events subscribers. So far it has been all internal, but ultimately, AuthGuard will run as part of a larger system. You can connect it to other parts of the system by providing an events bridge."><meta data-react-helmet="true" property="og:description" content="We touched on the messaging aspect of AuthGuard in the design sectio, and went more into details on how to subscribe to internal events in the events subscribers. So far it has been all internal, but ultimately, AuthGuard will run as part of a larger system. You can connect it to other parts of the system by providing an events bridge."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://authguard.github.io/docs/extend/cases/kafka"><link data-react-helmet="true" rel="alternate" href="https://authguard.github.io/docs/extend/cases/kafka" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://authguard.github.io/docs/extend/cases/kafka" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.73b2fc11.css">
<link rel="preload" href="/assets/js/runtime~main.a6b9e398.js" as="script">
<link rel="preload" href="/assets/js/main.169f3be6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/reduced_authguard_logo.png" alt="AuthGuard" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/reduced_authguard_logo.png" alt="AuthGuard" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">AuthGuard</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/api">API</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/authguard/AuthGuard" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/reduced_authguard_logo.png" alt="AuthGuard" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/reduced_authguard_logo.png" alt="AuthGuard" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">AuthGuard</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/intro">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/api">API</a></li><li class="menu__list-item"><a href="https://github.com/authguard/AuthGuard" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/intro">AuthGuard</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/features">Features</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/run">Running AuthGuard</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/quick-start">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/design">Design</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Extensions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extend/extend">Extending AuthGuard</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extend/exchange">Exchange Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extend/dal">Data Access Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extend/messaging">Event Subscribers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extend/bootstrap">Bootstrap Steps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extend/routes">API Routes</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Extensions Examples</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/extend/cases/kafka">Bridge to Kafka</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extend/cases/api-keys">Generating Custom API Keys</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/deployment">Deployment</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/setup">Setup and Usage</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/auth_scenarios">Authentication Scenarios</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/adminstration">Server Administration</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/federation">Identity Federation</a></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Bridge to Kafka</h1></header><div class="markdown"><p>We touched on the messaging aspect of AuthGuard in the <a href="/docs/design">design sectio</a>, and went more into details on how to subscribe to internal events in the <a href="/docs/extend/messaging">events subscribers</a>. So far it has been all internal, but ultimately, AuthGuard will run as part of a larger system. You can connect it to other parts of the system by providing an events bridge.</p><p>An event bridge simply takes internal events and pushes them to an external messaging system. It can also change the format and structure of the events to comply with your own standards if you have certain events structure already in place.</p><p>Here we show how to create a bridge which takes internal events and pushes them to a Kafka topic. The full source code of this example can be found <a href="https://www.github.com/AuthGuard/kafka-emb" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="configuration"></a>Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">#</a></h2><p>We need some configuration to make this work. Our configuration interface, <a href="https://immutables.github.io/" target="_blank" rel="noopener noreferrer">Immutables</a> is used to generate the actual class.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public interface KafkaConfiguration {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String getClientId();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;String&gt; getBootstrapHosts();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Map&lt;String, String&gt; getTopics();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Map&lt;String, String&gt; getProducerConfig();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In the configuration we expect some standard settings like client ID, Kafka bootstrap hosts, and producer config which will be passed to the producer. We also expect a map which maps internal channels to external topics.</p><p>The configuration can be obtained through Guice by injecting a <code>ConfigContext</code> with <code>@Named(&quot;kafka&quot;)</code> annotation.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="message-serialization"></a>Message Serialization<a class="hash-link" href="#message-serialization" title="Direct link to heading">#</a></h2><p>In order to publish a message to Kafka, you need something to serialize it. Kafka Java client already comes with a JSON serializer which is what we are going to use. Some methods were ommitted in the code snippet below but you can get the full example from the GitHub repo.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class MessageSerializer implements Serializer&lt;Message&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private final ObjectMapper objectMapper;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private final JsonSerializer jsonSerializer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public MessageSerializer() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this.objectMapper = new ObjectMapper();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this.jsonSerializer = new JsonSerializer();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public byte[] serialize(final String topic, final Message message) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        final JsonNode jsonNode = objectMapper.valueToTree(message);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return jsonSerializer.serialize(topic, jsonNode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kafka-publisher"></a>Kafka Publisher<a class="hash-link" href="#kafka-publisher" title="Direct link to heading">#</a></h2><p>We then prepare the publisher which will be used by our subscriber to publish to Kafka. We also ommitted the implementation of <code>KafkaProducerFactory</code> which is used below.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class KafkaPublisher {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private final ImmutableKafkaConfiguration config;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private final KafkaProducer&lt;String, Message&gt; kafkaProducer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @Inject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public KafkaPublisher(@Named(&quot;kafka&quot;) final ConfigContext config) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this(config.asConfigBean(ImmutableKafkaConfiguration.class));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    KafkaPublisher(final ImmutableKafkaConfiguration config) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this.config = config;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this.kafkaProducer = KafkaProducerFactory.create(this.config);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        LOG.info(&quot;Loaded Kafka publisher with config: {}&quot;, this.config);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public void publish(final Message message) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        final String topic = Optional.ofNullable(this.config.getTopics().get(message.getEventType().name()))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Unmapped event type &quot; + message.getEventType()));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        final ProducerRecord&lt;String, Message&gt; record = new ProducerRecord&lt;&gt;(topic, message);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        kafkaProducer.send(record, this::kafkaSendCallback);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private void kafkaSendCallback(final RecordMetadata metadata, final Exception e) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (e != null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            LOG.error(&quot;Failed to publish event with metadata {}&quot;, metadata, e);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bridge-implementation"></a>Bridge Implementation<a class="hash-link" href="#bridge-implementation" title="Direct link to heading">#</a></h2><p>And the final piece of the puzzle is the bridge itself</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@Channel(&quot;*&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class KafkaBridge implements MessageSubscriber {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private final KafkaPublisher kafkaPublisher;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @Inject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public KafkaBridge(final KafkaPublisher kafkaPublisher) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this.kafkaPublisher = kafkaPublisher;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public void onMessage(final Message message) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        kafkaPublisher.publish(message);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/extend/cases/kafka.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/extend/routes"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« API Routes</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/extend/cases/api-keys"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Generating Custom API Keys Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuration" class="table-of-contents__link">Configuration</a></li><li><a href="#message-serialization" class="table-of-contents__link">Message Serialization</a></li><li><a href="#kafka-publisher" class="table-of-contents__link">Kafka Publisher</a></li><li><a href="#bridge-implementation" class="table-of-contents__link">Bridge Implementation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Links</h4><ul class="footer__items"><li class="footer__item"><a href="https://nexblocks.com/nexblocks" target="_blank" rel="noopener noreferrer" class="footer__link-item">nex::blocks</a></li><li class="footer__item"><a href="https://nexblocks.com/nexblocks/portal" target="_blank" rel="noopener noreferrer" class="footer__link-item">Licenses</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 nex::blocks. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a6b9e398.js"></script>
<script src="/assets/js/main.169f3be6.js"></script>
</body>
</html>